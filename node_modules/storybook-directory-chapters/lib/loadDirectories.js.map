{"version":3,"sources":["../index.js"],"names":[],"mappings":"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","file":"loadDirectories.js","sourcesContent":["// @flow\n\nimport { storiesOf } from '@storybook/react';\nimport type { Story } from '@storybook/react';\nimport type { Context } from 'storybook-directory-chapters';\n\ninterface Data {\n  dirs: string[];\n  stories?: Story;\n}\n\ninterface Cursors {\n  increase: number;\n  decrease: number;\n}\n\nconst initData: Data = { dirs: [] };\n\nexport default function loadDirectories(context: Context) {\n  context.keys().reduce((acc, c) => {\n    const dirs = getDirs(c);\n\n    if (!dirs.length) return acc;\n  \n    let stories;\n    let lastDirs = acc.dirs.concat();\n\n    if (acc.stories) {\n      stories = Object.assign({}, acc.stories);\n    } else {\n      stories = createStories(dirs[0]);\n      lastDirs = [dirs[0]];\n    }\n\n    // check the diff between the current path and the previous path\n    let cursorsToMove = cursorsToPath(lastDirs, dirs);\n\n    // check how many chapters to end\n    stories = endChapters(stories, cursorsToMove.decrease);\n\n    // if top level directories change, create new stories and reset the cursors\n    if (shouldCreateStories(lastDirs, dirs)) {\n      stories = createStories(dirs[0]);\n      lastDirs = [dirs[0]];\n      cursorsToMove = cursorsToPath(lastDirs, dirs);\n    }\n\n    // check how many chapters to add\n    stories = addChapters(stories, cursorsToMove.increase,\n      dirs.slice(lastDirs.length - cursorsToMove.decrease));\n  \n    stories = context(c)(stories);\n    return { dirs, stories };\n  }, initData);\n}\n\nfunction getDirs(path: string): string[] {\n  return path.replace(/..?\\//, '').split('/').reverse().slice(1).reverse();\n}\n\nfunction shouldCreateStories(a: string[], b: string[]): boolean {\n  return a[0] !== b[0];\n}\n\nfunction createStories(name: string): Story {\n  return storiesOf(name, module);\n}\n\nfunction addChapters(stories: Story, i: number, dirs: string[]): Story {\n  let name;\n  switch (i) {\n    case 0:\n      return stories;\n    default:\n      name = dirs.concat().reverse()[i - 1];\n      return addChapters(stories.chapter(name), i - 1, dirs);\n  }\n}\n\nfunction endChapters(stories: Story, i: number): Story {\n  switch (i) {\n    case 0:\n      return stories;\n    default:\n      return endChapters(stories.endOfChapter(), i - 1);\n  }\n}\n\nfunction cursorsToPath(a: string[], b: string[]): Cursors {\n\n  const dt = a.length - b.length;\n  const min = Math.min(a.length, b.length);\n  const max = Math.max(a.length, b.length);\n\n  const cursors: Cursors = { increase: 0, decrease: 0 };\n\n  for (let i = 0; i < min; i++) {\n    if (a[i] === b[i]) continue;\n\n    if (dt <= 0) {\n      // got larger or the same\n      // it increases from the diff point even when the lengths are the same\n      cursors.increase = max - i;\n    }\n    // either got larger or the same or got smaller\n    cursors.decrease = min - i;\n    return cursors;\n  }\n  \n  if (dt < 0) {\n    // got larger\n    cursors.increase = max - min;\n  } else if (dt > 0) {\n    // got smaller\n    cursors.decrease = max - min; // (min - max) * -1\n  }\n  return cursors;\n}\n"]}