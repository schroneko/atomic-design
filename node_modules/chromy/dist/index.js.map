{"version":3,"sources":["../src/index.js"],"names":["fs","require","nodeUrl","CDP","uuidV4","devices","createFullscreenEmulationManager","Jimp","Document","TimeoutError","GotoTimeoutError","createChromeLauncher","completeUrl","instances","instanceId","makeSendToChromy","uuid","defaultTargetFunction","targets","filter","t","type","shift","Chromy","options","chromePath","process","env","CHROME_PATH","defaults","host","port","launchBrowser","userDataDir","chromeFlags","enableExtensions","activateOnStartUp","waitTimeout","gotoTimeout","loadTimeout","evaluateTimeout","waitFunctionPollingInterval","typeInterval","target","Object","assign","cdpOptions","client","launcher","messagePrefix","emulateMode","currentEmulateDeviceName","currentDeviceScaleFactor","userAgentBeforeEmulate","startingUrl","_sigintHandler","close","exit","on","pid","Error","push","Promise","resolve","reject","DOM","Network","Page","Runtime","Console","all","enable","_cacheChromeVersion","_chromeVersion","console","warn","_getTargetIdFromOption","targetId","Target","activateTarget","userAgent","headers","_activateOnDocumentUpdatedListener","err","catch","e","getTargets","result","page","targetInfos","kill","removeListener","i","ua","_checkStart","setUserAgentOverride","setExtraHTTPHeaders","Security","setOverrideCertificateErrors","override","certificateError","eventId","handleCertificateError","action","callback","messageAdded","payload","msg","message","text","pre","substring","length","apply","f","defineFunction","sendToChromy","data","JSON","parse","url","format","defaultOptions","waitLoadEvent","response","requestListener","redirectResponse","location","requestEventName","listener","eventName","_waitFinish","navigate","loadEventFired","promise","evaluate","expression","ignoreCache","scriptToEvaluateOnLoad","reload","def","funcs","Array","isArray","_moduleToFunctionSources","toString","module","funcName","func","src","trim","x","y","opts","Input","dispatchMouseEvent","button","time","Date","now","timestamp","synthesizeTapGesture","tapCount","selector","files","paramFiles","getDocument","root","querySelector","nodeId","fileNodeId","setFileInputFiles","quality","undefined","fromSurface","useDeviceResolution","params","indexOf","captureParams","captureScreenshot","captureResult","image","Buffer","from","_getScreenInfo","screen","devicePixelRatio","read","img","fmt","MIME_PNG","MIME_JPEG","scale","RESIZE_BEZIER","getBuffer","buffer","model","emulation","emulate","screenshotParams","screenshot","reset","_restoreEmulationSetting","_screenshotSelector","scrollTo","getBoundingClientRect","rect","width","height","clip","left","top","screenshotOpts","selectors","_screenshotMultipleSelectors","useQuerySelectorAll","selIdx","rects","rectAll","r","reason","rectIdx","printToPDF","screencastFrame","screencastFrameAck","sessionId","startScreencast","stopScreencast","requestWillBeSent","event","parameter","send","once","removeAllListeners","fileOrBuffer","readFile","encoding","script","replace","expr","style","deviceScaleFactor","Emulation","setDeviceMetricsOverride","mobile","deviceName","device","fitWindow","pageScaleFactor","platform","setTouchEmulationEnabled","enabled","configuration","clearDeviceMetricsOverride","setDeviceScaleFactor","urls","setBlockedURLs","clearBrowserCache","paramArray","href","currentUrl","map","obj","item","setCookie","name","nameArray","paramUrl","n","deleteCookie","cookieName","clearBrowserCookies","Memory","getDOMCounters","origin","Storage","clearDataForOrigin","storageTypes","start","_getChromeVersion","product","navigator","v","match","parseInt","cusDevices","forEach","copy","concat","promises","exports"],"mappings":"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","file":"index.js","sourcesContent":["const fs = require('fs')\nconst nodeUrl = require('url')\n\n/**\n * Chrome Debugging Protocol wrapper class\n *\n * @external CDP\n *\n * @see {@link https://www.npmjs.com/package/chrome-remote-interface#cdpoptions-callback}\n */\nconst CDP = require('chrome-remote-interface')\nconst uuidV4 = require('uuid/v4')\nconst devices = require('./devices')\nconst {createFullscreenEmulationManager} = require('./emulation')\nconst Jimp = require('jimp')\n\nconst Document = require('./document')\n\nconst {\n  TimeoutError,\n  GotoTimeoutError,\n} = require('./error')\nconst {\n  createChromeLauncher,\n  completeUrl,\n} = require('./util')\n\nlet instances = []\nlet instanceId = 1\n\nfunction makeSendToChromy (uuid) {\n  return `\n  function () {\n    console.info('${uuid}:' + JSON.stringify(arguments))\n  }\n  `\n}\n\nfunction defaultTargetFunction (targets) {\n  return targets.filter(t => t.type === 'page').shift()\n}\n\nclass Chromy extends Document {\n  constructor (options = {}) {\n    super(null, null, null)\n    let chromePath = null\n    if (options.chromePath) {\n      chromePath = options.chromePath\n    } else if (process.env.CHROME_PATH) {\n      chromePath = process.env.CHROME_PATH\n    }\n    const defaults = {\n      host: 'localhost',\n      port: 9222,\n      launchBrowser: true,\n      userDataDir: null,\n      chromeFlags: [],\n      chromePath: chromePath,\n      enableExtensions: false,\n      activateOnStartUp: true,\n      waitTimeout: 30000,\n      gotoTimeout: 30000,\n      loadTimeout: 30000,\n      evaluateTimeout: 30000,\n      waitFunctionPollingInterval: 100,\n      typeInterval: 20,\n      target: defaultTargetFunction,\n    }\n    this.options = Object.assign({}, defaults, options)\n    this.cdpOptions = {\n      host: this.options.host,\n      port: this.options.port,\n      target: this.options.target,\n    }\n    this.client = null\n    this.launcher = null\n    this.messagePrefix = null\n    this.emulateMode = false\n    this.currentEmulateDeviceName = null\n    this.currentDeviceScaleFactor = null\n    this.userAgentBeforeEmulate = null\n    this.instanceId = instanceId++\n  }\n\n  static addCustomDevice (cusDevices = []) {\n    if (!Array.isArray(cusDevices)) {\n      cusDevices = [cusDevices]\n    }\n    cusDevices.forEach(item => {\n      devices[item.name] = item\n    })\n  }\n\n  async start (startingUrl = null) {\n    if (startingUrl === null) {\n      startingUrl = 'about:blank'\n    }\n    if (this.client !== null) {\n      return\n    }\n\n    if (this.options.launchBrowser) {\n      if (this.launcher === null) {\n        this.launcher = await createChromeLauncher(completeUrl(startingUrl), this.options)\n        this._sigintHandler = async () => {\n          await this.close()\n          process.exit(130)\n        }\n        process.on('SIGINT', this._sigintHandler)\n      }\n\n      if (!this.launcher.pid) {\n        throw new Error('Failed to launch a browser.')\n      }\n      instances.push(this)\n    }\n\n    await new Promise((resolve, reject) => {\n      CDP(this.cdpOptions, async (client) => {\n        try {\n          this.client = client\n          const {DOM, Network, Page, Runtime, Console} = client\n          await Promise.all([DOM.enable(), Network.enable(), Page.enable(), Runtime.enable(), Console.enable()])\n\n          await this._cacheChromeVersion()\n          if (this._chromeVersion < 61) {\n            console.warn('Chromy requires Chrome ver.61 or later. Please install latest version Chrome.')\n          }\n\n          // activate first tab\n          if (this.options.activateOnStartUp) {\n            let targetId = await this._getTargetIdFromOption()\n            await this.client.Target.activateTarget({targetId: targetId})\n          }\n\n          if ('userAgent' in this.options) {\n            await this.userAgent(this.options.userAgent)\n          }\n          if ('headers' in this.options) {\n            await this.headers(this.options.headers)\n          }\n          this._activateOnDocumentUpdatedListener()\n          resolve(this)\n        } catch (e) {\n          reject(e)\n        }\n      }).on('error', (err) => {\n        reject(err)\n      })\n    }).catch(e => {\n      throw e\n    })\n  }\n\n  async _getTargetIdFromOption () {\n    if (typeof this.options.target === 'function') {\n      const result = await this.client.Target.getTargets()\n      const page = this.options.target(result.targetInfos)\n      return page.targetId\n    } else if (typeof this.options.target === 'object') {\n      return this.options.target.targetId\n    } else if (typeof this.options.target === 'string') {\n      return this.options.target\n    } else {\n      throw new Error('type of `target` option is invalid.')\n    }\n  }\n\n  async close () {\n    if (this.client === null) {\n      return false\n    }\n    await this.client.close()\n    this.client = null\n    if (this.launcher !== null) {\n      await this.launcher.kill()\n      process.removeListener('SIGINT', this._sigintHandler)\n      this.launcher = null\n    }\n    instances = instances.filter(i => i.instanceId !== this.instanceId)\n    return true\n  }\n\n  static async cleanup () {\n    const copy = [].concat(instances)\n    const promises = copy.map(i => i.close())\n    await Promise.all(promises)\n  }\n\n  async getPageTargets () {\n    const result = await this.client.Target.getTargets()\n    return result.targetInfos.filter(t => t.type === 'page')\n  }\n\n  async userAgent (ua) {\n    await this._checkStart()\n    return await this.client.Network.setUserAgentOverride({'userAgent': ua})\n  }\n\n  /**\n   * Example:\n   * chromy.headers({'X-Requested-By': 'foo'})\n   */\n  async headers (headers) {\n    await this._checkStart()\n    return await this.client.Network.setExtraHTTPHeaders({'headers': headers})\n  }\n\n  async ignoreCertificateErrors () {\n    await this._checkStart()\n    await this.client.Security.enable()\n    await this.client.Security.setOverrideCertificateErrors({override: true})\n    await this.client.Security.certificateError(({eventId}) => {\n      this.client.Security.handleCertificateError({\n        eventId,\n        action: 'continue',\n      })\n    })\n  }\n\n  async console (callback) {\n    await this._checkStart()\n    this.client.Console.messageAdded((payload) => {\n      try {\n        const msg = payload.message.text\n        const pre = this.messagePrefix\n        if (typeof msg !== 'undefined') {\n          if (pre === null || msg.substring(0, pre.length + 1) !== pre + ':') {\n            callback.apply(this, [msg, payload.message])\n          }\n        }\n      } catch (e) {\n        console.warn(e)\n      }\n    })\n  }\n\n  async receiveMessage (callback) {\n    await this._checkStart()\n    const uuid = uuidV4()\n    this.messagePrefix = uuid\n    const f = makeSendToChromy(this.messagePrefix)\n    this.defineFunction({sendToChromy: f})\n    this.client.Console.messageAdded((payload) => {\n      try {\n        const msg = payload.message.text\n        if (msg && msg.substring(0, uuid.length + 1) === uuid + ':') {\n          const data = JSON.parse(msg.substring(uuid.length + 1))\n          callback.apply(this, [data])\n        }\n      } catch (e) {\n        console.warn(e)\n      }\n    })\n  }\n\n  async goto (url, options) {\n    // correct url form.\n    url = nodeUrl.format(nodeUrl.parse(url))\n    const defaultOptions = {\n      waitLoadEvent: true,\n    }\n    options = Object.assign({}, defaultOptions, options)\n    await this._checkStart(url)\n    let response = null\n    // truck redirects.\n    let requestListener = (payload) => {\n      if (payload.redirectResponse && payload.redirectResponse.url === url) {\n        url = payload.redirectResponse.headers.location\n      }\n    }\n    const requestEventName = 'Network.requestWillBeSent'\n    await this.on(requestEventName, requestListener)\n    let listener = (payload) => {\n      if (payload.response.url === url) {\n        response = payload.response\n      }\n    }\n    const eventName = 'Network.responseReceived'\n    await this.on(eventName, listener)\n    try {\n      await this._waitFinish(this.options.gotoTimeout, async () => {\n        await this.client.Page.navigate({url: completeUrl(url)})\n        if (options.waitLoadEvent) {\n          await this.client.Page.loadEventFired()\n        }\n      })\n    } catch (e) {\n      if (e instanceof TimeoutError) {\n        throw new GotoTimeoutError('goto() timeout')\n      } else {\n        throw e\n      }\n    } finally {\n      await this.removeListener(eventName, listener)\n      await this.removeListener(requestEventName, requestListener)\n    }\n    return response\n  }\n\n  async waitLoadEvent () {\n    await this._waitFinish(this.options.loadTimeout, async () => {\n      await this.client.Page.loadEventFired()\n    })\n  }\n\n  async forward () {\n    const f = 'window.history.forward()'\n    const promise = this.waitLoadEvent()\n    await this.client.Runtime.evaluate({expression: f})\n    await promise\n  }\n\n  async back () {\n    const f = 'window.history.back()'\n    const promise = this.waitLoadEvent()\n    await this.client.Runtime.evaluate({expression: f})\n    await promise\n  }\n\n  async reload (ignoreCache, scriptToEvaluateOnLoad) {\n    await this.client.Page.reload({ignoreCache, scriptToEvaluateOnLoad})\n  }\n\n  /**\n   * define function\n   *\n   * @param func {(function|string|Array.<function>|Array.<string>)}\n   * @returns {Promise.<void>}\n   */\n  async defineFunction (def) {\n    let funcs = []\n    if (Array.isArray(def)) {\n      funcs = def\n    } else if ((typeof def) === 'object') {\n      funcs = this._moduleToFunctionSources(def)\n    } else {\n      funcs.push(def)\n    }\n    for (let i = 0; i < funcs.length; i++) {\n      let f = funcs[i]\n      if ((typeof f) === 'function') {\n        f = f.toString()\n      }\n      await this.client.Runtime.evaluate({expression: f})\n    }\n  }\n\n  _moduleToFunctionSources (module) {\n    const result = []\n    for (let funcName in module) {\n      let func = module[funcName]\n      let src = `function ${funcName} () { return (${func.toString()})(...arguments) }`.trim()\n      result.push(src)\n    }\n    return result\n  }\n\n  async mouseMoved (x, y, options = {}) {\n    const opts = Object.assign({type: 'mouseMoved', x: x, y: y}, options)\n    await this.client.Input.dispatchMouseEvent(opts)\n  }\n\n  async mousePressed (x, y, options = {}) {\n    const opts = Object.assign({type: 'mousePressed', x: x, y: y, button: 'left'}, options)\n    await this.client.Input.dispatchMouseEvent(opts)\n  }\n\n  async mouseReleased (x, y, options = {}) {\n    const opts = Object.assign({type: 'mouseReleased', x: x, y: y, button: 'left'}, options)\n    await this.client.Input.dispatchMouseEvent(opts)\n  }\n\n  async tap (x, y, options = {}) {\n    const time = Date.now() / 1000\n    const opts = Object.assign({x: x, y: y, timestamp: time, button: 'left'}, options)\n    await this.client.Input.synthesizeTapGesture(opts)\n  }\n\n  async doubleTap (x, y, options = {}) {\n    const time = Date.now() / 1000\n    const opts = Object.assign({x: x, y: y, timestamp: time, button: 'left', tapCount: 2}, options)\n    await this.client.Input.synthesizeTapGesture(opts)\n  }\n\n  async setFile (selector, files) {\n    let paramFiles = files\n    if ((typeof files) === 'string') {\n      paramFiles = [files]\n    }\n    if (paramFiles.length === 0) {\n      return\n    }\n    const {root} = await this.client.DOM.getDocument()\n    const {nodeId: fileNodeId} = await this.client.DOM.querySelector({\n      nodeId: root.nodeId,\n      selector: selector,\n    })\n    if (!fileNodeId) {\n      return\n    }\n    await this.client.DOM.setFileInputFiles({\n      nodeId: fileNodeId,\n      files: paramFiles,\n    })\n  }\n\n  async screenshot (format = 'png', quality = undefined, fromSurface = true) {\n    let opts = {\n      format: 'png',\n      fromSurface: true,\n      useDeviceResolution: false,\n    }\n    if ((typeof format) === 'string') {\n      // deprecated arguments style\n      const params = {\n        format: format,\n        quality: quality,\n        fromSurface: fromSurface,\n      }\n      opts = Object.assign({}, opts, params)\n    } else if ((typeof format) === 'object') {\n      opts = Object.assign({}, opts, format)\n    }\n    if (['png', 'jpeg'].indexOf(opts.format) === -1) {\n      throw new Error('format is invalid.')\n    }\n    const captureParams = Object.assign({}, opts)\n    delete captureParams.useDeviceResolution\n    let captureResult = await this.client.Page.captureScreenshot(captureParams)\n    let image = Buffer.from(captureResult.data, 'base64')\n    if (!opts.useDeviceResolution) {\n      const screen = await this._getScreenInfo()\n      if (screen.devicePixelRatio !== 1) {\n        let promise = new Promise((resolve, reject) => {\n          Jimp.read(image, (err, img) => {\n            if (err) {\n              return reject(err)\n            }\n            let fmt = opts.format === 'png' ? Jimp.MIME_PNG : Jimp.MIME_JPEG\n            let quality = 100\n            if (opts.quality) {\n              quality = opts.quality\n            }\n            img.scale(1.0 / screen.devicePixelRatio, Jimp.RESIZE_BEZIER)\n              .quality(quality)\n              .getBuffer(fmt, (err, buffer) => {\n                if (err) {\n                  reject(err)\n                } else {\n                  resolve(buffer)\n                }\n              })\n          })\n        })\n        image = await promise\n      }\n    }\n    return image\n  }\n\n  /*\n   * Limitation:\n   * maximum height is 16384px because of chrome's bug from Skia library.\n   * https://groups.google.com/a/chromium.org/d/msg/headless-dev/DqaAEXyzvR0/kUTEqNYiDQAJ\n   * https://stackoverflow.com/questions/44599858/max-height-of-16-384px-for-headless-chrome-screenshots\n   */\n  async screenshotDocument (model = 'scroll', format = 'png', quality = undefined, fromSurface = true) {\n    let opts = {\n      model: 'scroll',\n      format: 'png',\n      fromSurface: true,\n      useDeviceResolution: false,\n    }\n    if ((typeof model) === 'string') {\n      const params = {\n        model: model,\n        format: format,\n        quality: quality,\n        fromSurface: fromSurface,\n      }\n      opts = Object.assign({}, opts, params)\n    } else if ((typeof model) === 'object') {\n      opts = Object.assign({}, opts, model)\n    }\n    const emulation = await createFullscreenEmulationManager(this, opts.model, false, opts.useDeviceResolution)\n\n    let result = null\n    try {\n      await emulation.emulate()\n      // device resolution is already emulated by emulation manager, so useDeviceResotion must be set true\n      const screenshotParams = Object.assign({}, opts, {useDeviceResolution: true})\n      delete screenshotParams.model\n      result = await this.screenshot(screenshotParams)\n    } finally {\n      await emulation.reset()\n      // restore emulation mode\n      await this._restoreEmulationSetting()\n    }\n    return result\n  }\n\n  async screenshotSelector (selector, format = 'png', quality = undefined, fromSurface = true) {\n    let opts = {\n      format: 'png',\n      fromSurface: true,\n      useDeviceResolution: false,\n    }\n    if ((typeof format) === 'string') {\n      const params = {\n        format: format,\n        quality: quality,\n        fromSurface: fromSurface,\n      }\n      opts = Object.assign({}, opts, params)\n    } else if ((typeof format) === 'object') {\n      opts = Object.assign({}, opts, format)\n    }\n    return this._screenshotSelector(selector, opts)\n  }\n\n  async _screenshotSelector (selector, opts) {\n    const emulation = await createFullscreenEmulationManager(this, 'scroll', true, opts.useDeviceResolution)\n    let buffer = null\n    try {\n      await emulation.emulate()\n      await this.scrollTo(0, 0)\n      let rect = await this.getBoundingClientRect(selector)\n      if (!rect || rect.width === 0 || rect.height === 0) {\n        return null\n      }\n      let clip = {\n        x: rect.left,\n        y: rect.top,\n        width: rect.width,\n        height: rect.height,\n        scale: 1,\n      }\n      let screenshotOpts = Object.assign({}, opts, {clip})\n      const {data} = await this.client.Page.captureScreenshot(screenshotOpts)\n      buffer = Buffer.from(data, 'base64')\n    } finally {\n      emulation.reset()\n    }\n    return buffer\n  }\n\n  async screenshotMultipleSelectors (selectors, callback, options = {}) {\n    return this._screenshotMultipleSelectors(selectors, callback, options)\n  }\n\n  async _screenshotMultipleSelectors (selectors, callback, options = {}) {\n    const defaults = {\n      model: 'scroll',\n      format: 'png',\n      quality: undefined,\n      fromSurface: true,\n      useDeviceResolution: false,\n      useQuerySelectorAll: false,\n    }\n    const opts = Object.assign({}, defaults, options)\n    const emulation = await createFullscreenEmulationManager(this, 'scroll', true, opts.useDeviceResolution)\n    await emulation.emulate()\n    try {\n      for (let selIdx = 0; selIdx < selectors.length; selIdx++) {\n        let selector = selectors[selIdx]\n        try {\n          let rects = null\n          if (opts.useQuerySelectorAll) {\n            rects = await this.rectAll(selector)\n            // remove elements that has 'display: none'\n            rects = rects.filter(rect => rect.width !== 0 && rect.height !== 0)\n          } else {\n            const r = await this.getBoundingClientRect(selector)\n            if (r && r.width !== 0 && r.height !== 0) {\n              rects = [r]\n            }\n          }\n          if (rects.length === 0) {\n            const err = {reason: 'notfound', message: `selector is not found. selector=${selector}`}\n            await callback.apply(this, [err, null, selIdx, selectors])\n            continue\n          }\n\n          for (let rectIdx = 0; rectIdx < rects.length; rectIdx++) {\n            const rect = rects[rectIdx]\n            let clip = {\n              x: rect.left,\n              y: rect.top,\n              width: rect.width,\n              height: rect.height,\n              scale: 1,\n            }\n            let screenshotOpts = Object.assign({\n              format: opts.format,\n              quality: opts.quality,\n              fromSurface: opts.fromSurface,\n              clip,\n            })\n            const {data} = await this.client.Page.captureScreenshot(screenshotOpts)\n            let buffer = Buffer.from(data, 'base64')\n            await callback.apply(this, [null, buffer, selIdx, selectors, rectIdx])\n          }\n        } catch (e) {\n          await callback.apply(this, [e, null, selIdx, selectors])\n        }\n      }\n    } finally {\n      await emulation.reset()\n      await this._restoreEmulationSetting()\n    }\n  }\n\n  async pdf (options = {}) {\n    const {data} = await this.client.Page.printToPDF(options)\n    return Buffer.from(data, 'base64')\n  }\n\n  async startScreencast (callback, options = {}) {\n    await this.client.Page.screencastFrame(async (payload) => {\n      await callback.apply(this, [payload])\n      await this.client.Page.screencastFrameAck({sessionId: payload.sessionId})\n    })\n    await this.client.Page.startScreencast(options)\n  }\n\n  async stopScreencast () {\n    await this.client.Page.stopScreencast()\n  }\n\n  // deprecated since 0.3.4\n  async requestWillBeSent (callback) {\n    await this._checkStart()\n    await this.client.Network.requestWillBeSent(callback)\n  }\n\n  async send (event, parameter) {\n    await this._checkStart()\n    return this.client.send(event, parameter)\n  }\n\n  async on (event, callback) {\n    await this._checkStart()\n    this.client.on(event, callback)\n  }\n\n  async once (event, callback) {\n    await this._checkStart()\n    this.client.once(event, callback)\n  }\n\n  async removeListener (event, callback) {\n    await this._checkStart()\n    this.client.removeListener(event, callback)\n  }\n\n  async removeAllListeners (event) {\n    await this._checkStart()\n    this.client.removeAllListeners(event)\n  }\n\n  async inject (type, fileOrBuffer) {\n    const data = fileOrBuffer instanceof Buffer ? fileOrBuffer.toString('utf8') : await new Promise((resolve, reject) => {\n      fs.readFile(fileOrBuffer, {encoding: 'utf-8'}, (err, data) => {\n        if (err) reject(err)\n        resolve(data)\n      })\n    }).catch(e => {\n      throw e\n    })\n    if (type === 'js') {\n      let script = data.replace(/\\\\/g, '\\\\\\\\').replace(/'/g, '\\\\\\'').replace(/(\\r|\\n)/g, '\\\\n')\n      let expr = `\n      {\n         let script = document.createElement('script')\n         script.type = 'text/javascript'\n         script.innerHTML = '${script}'\n         document.body.appendChild(script)\n      }\n      `\n      return this.evaluate(expr)\n    } else if (type === 'css') {\n      let style = data.replace(/`/g, '\\\\`').replace(/\\\\/g, '\\\\\\\\') // .replace(/(\\r|\\n)/g, ' ')\n      let expr = `\n      {\n         let style = document.createElement('style')\n         style.type = 'text/css'\n         style.innerText = \\`\n        ${style}\n        \\`\n         document.head.appendChild(style)\n      }\n      `\n      return this.evaluate(expr)\n    } else {\n      throw new Error('found invalid type.')\n    }\n  }\n\n  async setDeviceScaleFactor (deviceScaleFactor) {\n    const screen = await this._getScreenInfo()\n    if (screen.devicePixelRatio === deviceScaleFactor) {\n      return\n    }\n    this.currentDeviceScaleFactor = deviceScaleFactor\n    return this.client.Emulation.setDeviceMetricsOverride({\n      width: 0, height: 0, deviceScaleFactor: deviceScaleFactor, mobile: false,\n    })\n  }\n\n  async emulate (deviceName) {\n    await this._checkStart()\n\n    if (!this.emulateMode) {\n      this.userAgentBeforeEmulate = await this.evaluate('return navigator.userAgent')\n    }\n    const device = devices[deviceName]\n    await this.client.Emulation.setDeviceMetricsOverride({\n      width: device.width,\n      height: device.height,\n      deviceScaleFactor: device.deviceScaleFactor,\n      mobile: device.mobile,\n      fitWindow: false,\n      scale: device.pageScaleFactor,\n    })\n    const platform = device.mobile ? 'mobile' : 'desktop'\n    await this.client.Emulation.setTouchEmulationEnabled({enabled: true, configuration: platform})\n    await this.userAgent(device.userAgent)\n    this.currentEmulateDeviceName = deviceName\n    this.emulateMode = true\n  }\n\n  async clearEmulate () {\n    await this.client.Emulation.clearDeviceMetricsOverride()\n    await this.client.Emulation.setTouchEmulationEnabled({enabled: false})\n    if (this.userAgentBeforeEmulate) {\n      await this.userAgent(this.userAgentBeforeEmulate)\n    }\n    this.emulateMode = false\n    this.currentEmulateDeviceName = null\n  }\n\n  async _restoreEmulationSetting () {\n    // restore emulation mode\n    if (this.currentEmulateDeviceName !== null) {\n      await this.emulate(this.currentEmulateDeviceName)\n    }\n    if (this.currentDeviceScaleFactor) {\n      await this.setDeviceScaleFactor(this.currentDeviceScaleFactor)\n    }\n  }\n\n  async blockUrls (urls) {\n    await this._checkStart()\n    await this.client.Network.setBlockedURLs({urls: urls})\n  }\n\n  async clearBrowserCache () {\n    await this._checkStart()\n    await this.client.Network.clearBrowserCache()\n  }\n\n  async setCookie (params) {\n    await this._checkStart()\n    let paramArray = null\n    if (Array.isArray(params)) {\n      paramArray = params\n    } else {\n      paramArray = [params]\n    }\n    const currentUrl = await this.evaluate(_ => { return location.href })\n    paramArray = paramArray.map(obj => {\n      if (obj.url) {\n        return obj\n      } else {\n        obj.url = currentUrl\n        return obj\n      }\n    })\n    for (let i in paramArray) {\n      const item = paramArray[i]\n      await this.client.Network.setCookie(item)\n    }\n  }\n\n  async deleteCookie (name, url = null) {\n    await this._checkStart()\n    let nameArray = null\n    if (Array.isArray(name)) {\n      nameArray = name\n    } else {\n      nameArray = [name]\n    }\n    let paramUrl = url\n    if (!url) {\n      paramUrl = await this.evaluate(_ => { return location.href })\n    }\n    for (let i in nameArray) {\n      const n = nameArray[i]\n      await this.client.Network.deleteCookie({cookieName: n, url: paramUrl})\n    }\n  }\n\n  async clearAllCookies () {\n    await this._checkStart()\n    await this.client.Network.clearBrowserCookies()\n  }\n\n  async getDOMCounters () {\n    return await this.client.Memory.getDOMCounters()\n  }\n\n  async clearDataForOrigin (origin = null, type = 'all') {\n    if (origin === null) {\n      origin = await this.evaluate(_ => { return location.origin })\n    }\n    return await this.client.Storage.clearDataForOrigin({origin: origin, storageTypes: type})\n  }\n\n  async _checkStart (startingUrl = null) {\n    if (this.client === null) {\n      await this.start(startingUrl)\n    }\n  }\n\n  async _cacheChromeVersion () {\n    this._chromeVersion = await this._getChromeVersion()\n  }\n\n  async _getChromeVersion () {\n    let userAgent = null\n    try {\n      const result = await this.client.send('Browser.getVersion')\n      userAgent = result.product\n    } catch (_) {\n      // ignore\n    }\n    if (userAgent === null) {\n      userAgent = await this.evaluate(_ => {\n        return navigator.userAgent\n      })\n    }\n    let v = userAgent.match(/Chrom(e|ium)\\/([0-9]+)\\./)\n    return v ? parseInt(v[2], 10) : false\n  }\n}\n\nmodule.exports = Chromy\n\n"]}